require("dotenv").config();

let Analyser = require("./analyzer");

const TelegramBot = require('node-telegram-bot-api');
const moment = require("moment");

const bot = new TelegramBot(process.env.TGTOKEN, {polling: true});

let warnReply = [
    "–¢—ã —â–∞ –æ—Ç—ä–µ–¥–µ—à—å)",
    "–ª—É—á—à–µ —Å–∫–∞–∂–∏ –º–Ω–µ - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä—É –∏–ª–∏ –Ω–µ—Ç?",
    "—è –≤—Å—ë –ø–æ–Ω–∏–º–∞—é, –Ω–æ –Ω–µ —É —Ç–µ–±—è –æ–¥–Ω–æ–≥–æ –¥–µ–Ω—å –Ω–µ –∑–∞–¥–∞–ª—Å—è",
    "–±–æ—Ç–∞ –ª–µ–≥–∫–æ –æ—Å–∫–æ—Ä–±–∏—Ç—å, –∫–æ–≥–¥–∞ –±–æ–ª—å—à–µ –Ω–∏ –Ω–∞ —á—Ç–æ –Ω–µ —Å–ø–æ—Å–æ–±–µ–Ω.\n(—Å) –∞–ª—å–±–µ—Ä–±–æ—Ç –±–æ—Ç—ç–µ–Ω—à—Ç–µ–π–Ω",
    "–∞–≥–∞",
    "—Å–µ–≥–æ–¥–Ω—è —Ç—ã —Ç—É—Ç üèö –∑–∞–≤—Ç—Ä–∞ —Ç—ã —Ç–∞–º #",
    "–¥–ª—è —Ç–µ–±—è –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - –∑–∞ 99‚ÇΩ –Ω–µ –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –º–≤–¥",
    "–æ–π –≤—Å—ë",
    "–∫—Ç–æ –±—ã –≥–æ–≤–æ—Ä–∏–ª",
    "—Ç—ã –µ—â—ë –º–Ω–µ –ø–æ–ø–ª–∞–∫–∞–∏ —Ç—É—Ç.",
    "–º–µ–Ω—è –º–æ–∂–µ—à—å –æ–±–∏–∂–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ, —è —Ç–æ–ª—å–∫–æ –≥–æ–≤–æ—Ä—é –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Ç—ã –∑–∞ —ç—Ç–æ –ø—Ä–∏—Å—è–¥–µ—à—å",
    "—Ç—ã –Ω–∞–≤–µ—Ä–Ω–æ–µ –Ω–µ —Ö–æ—Ç–µ–ª –±—ã –∑–∞ —ç—Ç–æ –≤ –∞–≤—Ç–æ–∑–∞–∫–µ —Å–ø–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è –Ω–æ—á—å—é",
    "+2 –≥–æ–¥–∞",
    "+5 –ª–µ—Ç",
    "+10–∫ —à—Ç—Ä–∞—Ñ–∞",
    "+50–∫ —à—Ç—Ä–∞—Ñ–∞",
    "https://pokupki.market.yandex.ru/product/mylo-kuskovoe-s-verevochkoi-la-savonnerie-de-nyons-lait-d-anesse-bio-220-g/101062886787",
    "https://shambala-tea.ru/pages/stati/chifir/",
    "zayava",
    "–≤–∞—à —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π rating -50000 –±–∞–ª–ª–æ–≤. –≤—ã –Ω–∞–∫–∞–∑–∞–Ω—ã –º–∏–Ω—É—Å –º–∏—Å–∫–∞ —Ä–∏—Å –≤ –¥–µ–Ω—å –≤–æ —Å–ª–∞–≤—É –ö–∏—Ç–∞—è –∏ –≥–æ—Å–ø–æ–¥–∏–Ω–∞ –¶–∏",
    "—Å —ç—Ç–æ–≥–æ –¥–Ω—è —Ç–µ–±–µ –ª—É—á—à–µ –∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
    "—à—É—Ç–∫–∏ —à—É—Ç–∏—Ç—å –≤–∑–¥—É–º–∞–ª?",
    "–ø—Ä–æ–¥–æ–ª–∂–∞–π, —è –∑–∞–ø–∏—Å—ã–≤–∞—é",
    "–º–æ–∂–µ—à—å –ø–æ–∫–∞ –ø—Ä–∏–≥–ª—è–¥–µ—Ç—å—Å—è https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BF%D0%B5%D0%BD%D0%B8%D1%82%D0%B5%D0%BD%D1%86%D0%B8%D0%B0%D1%80%D0%BD%D1%8B%D1%85_%D1%83%D1%87%D1%80%D0%B5%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D0%B9_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B8",
    "–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ. –≤ —Ç–≤–æ–µ–π —Ç–∞—Ä–µ–ª–∫–µ –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å–æ–ª–µ–Ω–Ω–∞—è –∫–∞–∫ —Ä–µ–∑–∏–Ω–∞ –ø–µ—á–µ–Ω—å - –Ω–∏–∫—Ç–æ –Ω–µ –≤–µ—á–µ–Ω"
]
let rnd = (arr) => arr[ Math.abs(Math.ceil(Math.random()*arr.length-1)) ]

bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    console.log(msg)

    // send a message to the chat acknowledging receipt of their message
    // bot.sendMessage(chatId, 'Received your message');
    if(msg.new_chat_participant){
        if(msg.new_chat_participant.username === "MyPocketLawyerBot"){
            bot.sendMessage(chatId, "–¢–∞–∫-—Ç–∞–∫.\n–û—á–µ–Ω—å —Ä–∞–¥ –≤—Å–µ—Ö –≤–∞—Å –≤–∏–¥–µ—Ç—å, –Ω–∞–¥–µ—é—Å—å –Ω–∏–∫—Ç–æ –Ω–µ —Å—è–¥–µ—Ç –Ω–∞ –ø–∞—Ä—É-—Ç—Ä–æ–π–∫—É –ª–µ—Ç.", {disable_notification: true})
        }
    }

    let text = msg.text;
    if(text){
        let analysis = await Analyser(text);
        if(msg.chat.id == msg.from.id){
            // –ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

            // –†–µ–∞–∫—Ü–∏—è –Ω–∞ /start
            if(text == "/start"){
                bot.sendMessage(chatId, "üëÆ‚Äç‚ôÇÔ∏è –ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—è –≤ –ª—é–±–æ–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç\nüíå –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –º–Ω–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä—è–º–æ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å!\n\nüëâ –í –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ —É –º–µ–Ω—è –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: —è –¥–µ–ª–∞—é —Ñ–æ—Ä–≤–∞—Ä–¥ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –Ω–∞–π–¥—É –æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–µ —Å–ø–∞–º–ª—é.\n\nüôÖ‚Äç‚ôÇÔ∏è –ï—Å–ª–∏ —á—Ç–æ, —è –Ω–µ —Å–ª–∏–≤–∞—é —Ç–µ–∫—Å—Ç –æ—Ä–≥–∞–Ω–∞–º –∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é.\n–≠—Ç–æ –Ω–µ *–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è* —é—Ä. –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∏ –±–æ—Ç –Ω–µ—Å—ë—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—â–∞–µ–º–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ, –ª—É—á—à–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —é—Ä–∏—Å—Ç—É.\n\n–≠—Ç–æ –ø—Ä–æ–µ–∫—Ç –≤–æ—Ç —ç—Ç–æ–≥–æ –ø–∞—Ä–Ω—è:\nhttps://www.youtube.com/channel/UC__J7No7B1V5cBR5fVWqW8A")
                return;
            }

            if(analysis.isWarning){
                bot.sendMessage(chatId, analysis.warningTextFull, {reply_to_message_id: msg.message_id})
            }else{
                bot.sendMessage(chatId, "ü§û –í—Ä–æ–¥–µ –≤—Å—ë —á–∏–∫–∏ –ø—É–∫–∏", {reply_to_message_id: msg.message_id})
            }

            return;
        }

        // –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç
        if(analysis.isWarning){
            if(msg.reply_to_message){
                // –∑–ª–æ–π —Ä–µ–ø–ª–∞–π –Ω–∞ –±–æ—Ç–∞
                let t = rnd(warnReply);
                if(t=="zayava") t = `–ò–°–ö–û–í–û–ï –ó–ê–Ø–í–õ–ï–ù–ò–ï\n${moment().utcOffset(3).format("DD.MM YYYY")} –≥. –º–Ω–µ —Å—Ç–∞–ª–æ –∏–∑–≤–µ—Å—Ç–Ω–æ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥ –Ω–∏–∫–æ–º @${msg.from.username} (–∏–º—è - ${msg.from.first_name||"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}) —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ —Å–≤–µ–¥–∏–Ω–∏—è ¬´${msg.text}¬ª, –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —Å–µ—Ç–∏ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä Telegram —Ä–æ–≤–Ω–æ –≤ ${moment().utcOffset(3).format("HH:mm")} –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏.\n–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—á–∏–∫–æ–º —Å–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ä–æ—á–∞—Ç –º–æ–∏ —á–µ—Å—Ç—å –∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ.\n–ü—Ä–æ—à—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã—à–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –ü—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–µ –†–§ –≥. –ú–æ—Å–∫–≤—ã –∏ –ø—Ä–∏–Ω—è—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞ (ID ${msg.chat.id}) –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–Ω—è—Ç—ã—Ö.`;
                bot.sendMessage(chatId, t, {reply_to_message_id: msg.message_id})
            }else{
                bot.sendMessage(chatId, analysis.warningText, {reply_to_message_id: msg.message_id, disable_notification: true})
            }
        }
    }

    //bot.sendMessage(chatId, "–ö—É–∫", {reply_to_message_id: msg.message_id, disable_notification: true})
});

